# ZeRO

State: 已完成

https://www.cnblogs.com/fasterai/p/18569921

级别 	 作用
Zero-0：不进行任何形式的状态分片，只把DeepSpeed当成数据并行分布式数据并行（DDP）来用。
Zero-1：执行优化器状态的划分，可以减少内存消耗到原来的**1/4**，同时保持通讯开销不变，数据并行度不受影响。

Zero-2：对优化器状态和梯度进行分片处理，实现了进一步的内存减少到原来的**1/8**，同时通讯开销和数据并行度仍然维持不变。

Zero-3：**分片优化器状态、梯度和参数，内存减少的幅度和数据并行度成线性关系。**举例来说，在64个GPU（即Nd等于64情况下）的情况下，内存消耗可以降低64倍。通讯量相对会增加50%。

Zero-Infinity：Zero-Infinity是在Zero-3的基础上进一步发展，它可以通过利用NVMe SSD拓展GPU和CPU的内存来支持训练更大型的模型。

ZeRO被分为了三个级别：

1. ZeRO1：对**优化器**状态进行拆分。**显存消耗减少 4 倍，通信量与数据并行相同。**
2. ZeRO2：在ZeRO1的基础上，对**梯度**进行拆分。**显存消耗减少 8 倍，通信量与数据并行相同。**
3. ZeRO3：在ZeRO2的基础上，对**模型参数**进行拆分。**模型占用的显存被平均分配到每个 GPU 中，显存消耗量与数据并行的并行度成线性反比关系，但通信量会有些许增加。**

![image.png](ZeRO%201c3e64a56621802c9916c927c74b7d91/image.png)

## **ZeRO1**

模型训练中，正向传播和反向传播并不会用到优化器状态，只有在梯度更新的时候才会使用梯度和优化器状态计算新参数。因此**每个进程单独使用一段优化器状态，对各自进程的参数更新完之后，再把各个进程的模型参数合并形成完整的模型。**

假设我们有 𝑁𝑑 个并行的进程，**ZeRO-1** 会将完整优化器的状态等分成 𝑁𝑑 份并储存在各个进程中。当反向传播完成之后，每个进程的优化器会对自己储存的优化器状态（包括Momentum、Variance 与 FP32 Master Parameters）进行计算与更新。**更新过后的`Partitioned FP32 Master Parameters`会通过`All-gather`传回到各个进程中。**完成一次完整的参数更新。**【更新当前进程对应要更新的参数→收集参数信息→广播到各个进程】**

通过 ZeRO-1 对优化器状态的分段化储存，7.5B 参数量的模型内存占用将由原始数据并行下的 **120GB 缩减到 31.4GB**。

## **ZeRO2**

第二阶段中对梯度进行了拆分，在一个Layer的梯度都被计算出来后： 梯度通过**`All-reduce`**进行聚合， **聚合后的梯度只会被某一个进程用来更新参数，因此其它进程上的这段梯度不再被需要，可以立马释放掉。【归约不同进程的梯度→广播梯度→只保留当前进程优化器对应的参数的梯度信息，释放其他无关的梯度信息，然后对应优化器更新梯度→收集其他进程的梯度→广播到其他进程】**

通过 ZeRO-2 对梯度和优化器状态的分段化储存，7.5B 参数量的模型内存占用将由 ZeRO-1 中 **31.4GB 进一步下降到 16.6GB**。

## **ZeRO3**

第三阶段就是对模型参数进行分割。在ZeRO3中，**模型的每一层都被切片，每个进程存储权重张量的一部分**。在前向和后向传播过程中（每个进程仍然看到不同的微批次数据），**不同的进程交换它们所拥有的部分（按需进行参数通信），并计算激活函数和梯度。**

初始化的时候。ZeRO3将一个模型中每个子层中的参数分片放到不同进程中，训练过程中，**每个进程进行正常的正向/反向传播，然后通过`All-gather`进行汇总**，构建成完整的模型。【当前进程的参数切片进行前向和反向传播→得到当前切片的梯度信息→归约梯度信息→广播梯度信息→只保留当前优化器所需梯度以更新优化器→收集更新后参数信息→收集全局参数信息→广播参数信息】

| 特性 | All-Reduce | All-Gather |
| --- | --- | --- |
| **操作类型** | 归约 + 广播 | 收集 + 广播 |
| **数据处理** | 对所有进程中的数据进行归约操作（如求和），然后广播结果 | 将所有进程中的数据收集起来，然后广播给所有进程 |
| **应用场景** | 梯度同步、参数平均、全局归约 | 数据收集、全局数据共享 |
| **结果** | 每个进程得到相同的归约结果 | 每个进程得到所有数据块的完整集合 |
| **通信量** | 较低，因为只传输归约后的结果 | 较高，因为需要传输所有数据块 |

## ZeRO0：简单数据并行